<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, height=1920">
    <title>Kiosk Infoscreen</title>
    <link rel="stylesheet" href="https://library.goo1.de/fontawesome/6.7.2/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #app {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .navigation {
            display: flex;
            gap: 10px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .nav-button {
            flex: 1;
            padding: 25px 20px;
            font-size: 28px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.6);
        }

        .nav-button.active {
            background: linear-gradient(135deg, #42A5F5 0%, #2196F3 100%);
            box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
        }

        .content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .page {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .page.active {
            opacity: 1;
            visibility: visible;
            display: flex;
            flex-direction: column;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .schedule-page {
            background-image: url('bg01.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            align-items: center;
            justify-content: center;
        }

        .schedule-image {
            background-image: url('schedule02.png?v=4321');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            width: 100%;
            height: 100%;
        }

        .merch-page {
            padding: 30px;
            background: white;
        }

        .merch-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
            justify-content: center;
            flex-shrink: 0;
        }

        .merch-button {
            padding: 18px 32px;
            font-size: 20px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 1 auto;
            min-width: 180px;
        }

        .merch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.5);
        }

        .merch-button.active {
            background: linear-gradient(135deg, #42A5F5 0%, #2196F3 100%);
            box-shadow: 0 6px 20px rgba(66, 165, 245, 0.6);
        }

        .merch-image-container {
            flex: 1;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 0;
        }

        .merch-footer {
            text-align: center;
            padding: 20px;
            font-size: 32px;
            font-weight: 600;
            color: #2196F3;
            flex-shrink: 0;
        }

        /* Marshalling Grid Styles */
        .marshalling-page {
            background: #1a1a1a;
            padding: 20px;
        }

        .marshalling-wall {
            width: 100%;
            height: 100%;
            display: grid;
            gap: 15px;
            place-content: center;
            grid-template-columns: repeat(var(--cols, 1), var(--item-w, 100px));
            grid-auto-rows: var(--item-h, 141px);
        }

        .marshalling-poster {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,.5);
            overflow: hidden;
            width: var(--item-w, 100px);
            height: var(--item-h, 141px);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all .3s ease;
            cursor: pointer;
        }

        .marshalling-poster:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(0,0,0,.7);
        }

        .marshalling-poster.is-marshalling {
            border: 1px solid #00000080;
            box-shadow: #808 0 0 1vw 1vw, #808 0 0 1vw 1vw;
        }

        .marshalling-poster img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .txt_marshalling {
            color: #88f;
            font-weight: bold;
            font-size: 1.5vh;
            position: absolute;
            top: 6px;
            left: 0;
            right: 0;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0,0,0,.4);
            animation: blink 1s linear infinite;
            z-index: 10;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Fullscreen Modal */
        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .fullscreen-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .fullscreen-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .fullscreen-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: -50px;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .fullscreen-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 32px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="navigation">
            <button
                v-for="page in pages"
                :key="page.id"
                class="nav-button"
                :class="{ active: currentPage === page.id }"
                @click="selectPage(page.id)"
            >
                <i :class="page.icon"></i> {{ page.name }}
            </button>
        </div>

        <div class="content">
            <!-- Schedule Page -->
            <div class="page schedule-page" :class="{ active: currentPage === 'schedule' }">
                <div class="schedule-image"></div>
            </div>

            <!-- Competition Page -->
            <div class="page" :class="{ active: currentPage === 'competition' }">
                <iframe src="https://scoring.dance/enUS/events/272/infoscreen"></iframe>
            </div>

            <!-- Marshalling Page with Grid -->
            <div class="page marshalling-page" :class="{ active: currentPage === 'marshalling' }">
                <div ref="marshallingWall" class="marshalling-wall">
                    <template v-for="item in marshallingRounds" :key="item.round_id + '-' + item.heat">
                        <div 
                            class="marshalling-poster" 
                            :class="{ 'is-marshalling': item.status == 5 }"
                            @click="toggleFullscreen(item)"
                        >
                            <p class="txt_marshalling" v-if="item.status == 5">
                                <i class="fa-solid fa-person-walking-dashed-line-arrow-right"></i>
                                MARSHALLING NOW
                            </p>
                            <img :src="getMarshallingImageUrl(item)" />
                        </div>
                    </template>
                </div>
            </div>

            <!-- Merch Page -->
            <div class="page merch-page" :class="{ active: currentPage === 'merch' }">
                <div class="merch-buttons">
                    <button
                        v-for="item in merchItems"
                        :key="item.id"
                        class="merch-button"
                        :class="{ active: currentMerch === item.id }"
                        @click="selectMerch(item.id)"
                    >
                        <i :class="item.icon"></i> {{ item.name }}
                    </button>
                </div>
                <div class="merch-image-container" :style="{ backgroundImage: 'url(' + currentMerchImage + ')' }">
                </div>
                <div class="merch-footer">
                    get dressed...
                </div>
            </div>
        </div>

        <!-- Fullscreen Modal -->
        <div class="fullscreen-modal" :class="{ active: fullscreenItem !== null }" @click.self="closeFullscreen">
            <div class="fullscreen-content" v-if="fullscreenItem">
                <button class="fullscreen-close" @click="closeFullscreen">
                    <i class="fas fa-times"></i> Close
                </button>
                <img :src="getMarshallingImageUrl(fullscreenItem)" />
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;

        const RATIO = Math.SQRT2; // A4 portrait â‰ˆ 1.4142 (height/width)
        const GAP = 15;

        createApp({
            data() {
                return {
                    currentPage: 'schedule',
                    currentMerch: 'overview',
                    inactivityTimer: null,
                    marshallingRounds: [],
                    marshallingRefreshTimer: null,
                    fullscreenItem: null,
                    pages: [
                        { id: 'schedule', name: 'Schedule', icon: 'fas fa-calendar-alt' },
                        { id: 'competition', name: 'Competition', icon: 'fas fa-trophy' },
                        { id: 'marshalling', name: 'Marshalling', icon: 'fas fa-list-check' },
                        { id: 'merch', name: 'Merch', icon: 'fas fa-shopping-bag' }
                    ],
                    merchItems: [
                        { id: 'overview', name: 'Overview', icon: 'fas fa-th-large', image: 'merchpics/pic00.jpg' },
                        { id: 'white', name: 'White T-Shirt', icon: 'fas fa-shirt', image: 'merchpics/pic01.jpg' },
                        { id: 'green', name: 'Green T-Shirt', icon: 'fas fa-shirt', image: 'merchpics/pic02.jpg' },
                        { id: 'shorts', name: 'Shorts', icon: 'fas fa-trouser', image: 'merchpics/pic03.jpg' },
                        { id: 'letterman', name: 'Letterman', icon: 'fas fa-jacket', image: 'merchpics/pic04.jpg' },
                        { id: 'pullover', name: 'Hoodie', icon: 'fas fa-jacket', image: 'merchpics/pic05.jpg' },
                        { id: 'cropwhite', name: 'Crop Top', icon: 'fas fa-shirt', image: 'merchpics/pic06.jpg' }
                    ]
                }
            },
            computed: {
                currentMerchImage() {
                    const item = this.merchItems.find(m => m.id === this.currentMerch);
                    return item ? item.image : 'merchpics/pic00.png';
                },
                currentMerchName() {
                    const item = this.merchItems.find(m => m.id === this.currentMerch);
                    return item ? item.name : 'Overview';
                }
            },
            methods: {
                resetInactivityTimer() {
                    console.log('Resetting inactivity timer');
                    if (this.inactivityTimer) {
                        clearTimeout(this.inactivityTimer);
                    }
                    this.inactivityTimer = setTimeout(() => {
                        console.log('Inactivity timeout - returning to schedule');
                        //this.currentPage = 'schedule';
                        this.currentMerch = 'overview';
                        this.closeFullscreen();
                    }, 120000); // 2 minutes
                },
                selectPage(id) {
                    console.log('selectPage called with:', id);
                    this.currentPage = id;
                    this.closeFullscreen();
                    this.$nextTick(() => {
                        if (id === 'marshalling') {
                            this.layoutMarshalling();
                        }
                    });
                },
                selectMerch(id) {
                    console.log('selectMerch called with:', id);
                    this.currentMerch = id;
                },
                
                // Marshalling Functions
                async loadMarshallingData() {
                    try {
                        const response = await fetch('https://scoring.dance/deDE/events/272/infoscreen?type=2&act=lists.json', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: 'act=lists.json'
                        });
                        const data = await response.json();
                        this.marshallingRounds = data.result || [];
                        this.$nextTick(() => {
                            this.layoutMarshalling();
                        });
                    } catch (error) {
                        console.error('Error loading marshalling data:', error);
                    }
                },

                getMarshallingImageUrl(item) {
                    if (!item) return '#';
                    return `https://scoring.dance/deDE/events/272/infoscreen?type=2&act=picture.jpg&round=${item.round_id}&page=${item.heat}&v=${item.status}${item.stamp2}`;
                },

                layoutMarshalling() {
                    const wall = this.$refs.marshallingWall;
                    if (!wall) return;

                    const n = this.marshallingRounds.length || 0;
                    if (n === 0) {
                        wall.style.setProperty('--cols', '1');
                        wall.style.setProperty('--item-w', '0px');
                        wall.style.setProperty('--item-h', '0px');
                        return;
                    }

                    const W = wall.clientWidth;
                    const H = wall.clientHeight;

                    let best = { area: -1, cols: 1, rows: n, w: 100, h: 100 * RATIO };

                    for (let cols = 1; cols <= n; cols++) {
                        const rows = Math.ceil(n / cols);
                        const gapsW = GAP * (cols - 1);
                        const gapsH = GAP * (rows - 1);
                        const maxWPerCol = (W - gapsW) / cols;
                        const maxHPerRow = (H - gapsH) / rows;

                        let itemW = Math.min(maxWPerCol, maxHPerRow / RATIO);
                        let itemH = itemW * RATIO;

                        if (itemW <= 0 || itemH <= 0) continue;

                        const area = itemW * itemH;
                        if (area > best.area) {
                            best = { area, cols, rows, w: itemW, h: itemH };
                        }
                    }

                    wall.style.setProperty('--cols', String(best.cols));
                    wall.style.setProperty('--item-w', `${Math.floor(best.w)}px`);
                    wall.style.setProperty('--item-h', `${Math.floor(best.h)}px`);
                },

                toggleFullscreen(item) {
                    if (this.fullscreenItem && this.fullscreenItem.round_id === item.round_id && this.fullscreenItem.heat === item.heat) {
                        this.closeFullscreen();
                    } else {
                        this.fullscreenItem = item;
                    }
                },

                closeFullscreen() {
                    this.fullscreenItem = null;
                }
            },
            watch: {
                currentPage(newVal) {
                    if (newVal === 'marshalling') {
                        this.loadMarshallingData();
                    }
                }
            },
            mounted() {
                console.log('App mounted!');
                console.log('Initial currentPage:', this.currentPage);
                this.resetInactivityTimer();

                // Load marshalling data initially and set up refresh
                this.loadMarshallingData();
                this.marshallingRefreshTimer = setInterval(() => {
                    this.loadMarshallingData();
                }, 60000); // Refresh every 60 seconds

                // Reset timer on any user interaction
                ['click', 'touchstart', 'mousemove'].forEach(event => {
                    document.addEventListener(event, () => {
                        this.resetInactivityTimer();
                    });
                });

                // Re-layout marshalling on resize
                window.addEventListener('resize', () => {
                    if (this.currentPage === 'marshalling') {
                        this.layoutMarshalling();
                    }
                });

                // Close fullscreen on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeFullscreen();
                    }
                });
            },
            beforeUnmount() {
                if (this.marshallingRefreshTimer) {
                    clearInterval(this.marshallingRefreshTimer);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>